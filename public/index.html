<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Habit Tracker Dashboard</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1118" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#10b981" media="(prefers-color-scheme: light)">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="vendor/tailwindcdn.js"></script>
  <script>
    // Improved palette (emerald + cyan accent) and surface tokens
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            primary: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22' },
            accent: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e', 950: '#082f49' }
          }
        }
      }
    };
  </script>
  <!-- Theme initialization & toggle helper (keep) -->
  <script>
    (function(){
      try {
        const stored = localStorage.getItem('ht_theme');
        const theme = stored || 'dark';
        if(theme === 'dark') document.documentElement.classList.add('dark');
        window.toggleTheme = function(){
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('ht_theme', isDark ? 'dark' : 'light');
        };
      } catch(e) {}
    })();
  </script>
  <script crossorigin src="vendor/react.production.min.js"></script>
  <script crossorigin src="vendor/react-dom.production.min.js"></script>
  <script src="vendor/babel.min.js"></script>
  
  <!-- Load Firebase config from external file -->
  <script src="firebase-config.js"></script>

  <!-- Firebase SDKs (module just to import and attach to window) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    
    // firebaseConfig is loaded from firebase-config.js
    const app = initializeApp(window.firebaseConfig);
    getAnalytics(app);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.provider = new GoogleAuthProvider();
    window.firebaseApi = { doc, onSnapshot, setDoc, signInWithPopup, signOut, onAuthStateChanged };
  </script>

  <style>
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    :root { --side-w: 240px; --day-min: 38px; --bar-max-h: 60px; --row-h: 52px; }
    /* Enhanced card + buttons */
    .card { background:#ffffff; border:1px solid #e2e8f0; border-radius:0.9rem; padding:1rem; box-shadow:0 2px 4px -2px rgba(0,0,0,0.06),0 4px 8px -2px rgba(0,0,0,0.04); transition:background-color .25s,border-color .25s,color .25s,box-shadow .25s,transform .25s; }
    .card:hover { box-shadow:0 4px 14px -2px rgba(0,0,0,0.18),0 2px 6px -2px rgba(0,0,0,0.1); }
    .dark .card { background:linear-gradient(145deg,#0f1e2d,#132637); border-color:#1e2d3d; box-shadow:0 2px 6px -2px rgba(0,0,0,0.55),0 0 0 1px rgba(255,255,255,0.03) inset; }
    .dark .card:hover { background:linear-gradient(145deg,#132637,#183449); }
    .btn-primary { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.55rem 1rem; font-weight:500; font-size:.8rem; letter-spacing:.25px; border-radius:.75rem; color:#fff; background-image:linear-gradient(92deg,#059669,#0ea5e9); border:1px solid rgba(255,255,255,0.08); box-shadow:0 2px 4px -1px rgba(0,0,0,0.25),0 0 0 1px rgba(255,255,255,0.06) inset; cursor:pointer; transition:box-shadow .25s,transform .18s,filter .25s; }
    .btn-primary:hover { box-shadow:0 4px 14px -2px rgba(0,0,0,0.35),0 0 0 1px rgba(255,255,255,0.08) inset; filter:brightness(1.05); }
    .btn-primary:active { transform:translateY(2px); }
    .btn-primary:disabled { opacity:.5; cursor:not-allowed; }
    .btn-soft { background:rgba(4,120,87,0.08); color:#065f46; border:1px solid rgba(4,120,87,0.18); padding:.45rem .8rem; border-radius:.65rem; font-size:.7rem; font-weight:500; letter-spacing:.3px; transition:background .25s,color .25s,border-color .25s; }
    .btn-soft:hover { background:rgba(4,120,87,0.14); }
    .dark .btn-soft { background:rgba(14,165,233,0.15); color:#7dd3fc; border-color:rgba(56,189,248,0.3); }
    .dark .btn-soft:hover { background:rgba(14,165,233,0.22); }
    .gradient-header { background:linear-gradient(120deg,#ffffffee,#f8fafcee 55%,#ecfdf5dd); }
    .dark .gradient-header { background:linear-gradient(120deg,#0b1118dd,#0f1b28dd 60%,#022c22bb); }
    /* Existing custom styles */
    .soft-scroll { scroll-behavior:smooth; }
    .habit-grid-wrapper { position:relative; overflow-x:auto; }
    .fade-left::before { content:""; position:sticky; left:0; width:24px; height:100%; display:block; pointer-events:none; z-index:10; background:linear-gradient(to right,#f1f5f9,rgba(241,245,249,0)); }
    .dark .fade-left::before { background:linear-gradient(to right,#0f172a,rgba(15,23,42,0)); }
    body.dragging-x { cursor: grabbing !important; }
    [data-drag-scroll]::-webkit-scrollbar { height: 10px; }
    [data-drag-scroll]::-webkit-scrollbar-track { background: transparent; }
    [data-drag-scroll]::-webkit-scrollbar-thumb { background: rgba(100,116,139,0.35); border-radius: 8px; }
    [data-drag-scroll]:hover::-webkit-scrollbar-thumb { background: rgba(100,116,139,0.55); }
    /* Skeleton shimmer */
    .skeleton { position:relative; overflow:hidden; background:linear-gradient(90deg,rgba(100,116,139,0.15),rgba(100,116,139,0.08)); border-radius:0.5rem; }
    .dark .skeleton { background:linear-gradient(90deg,rgba(51,65,85,0.35),rgba(51,65,85,0.25)); }
    .skeleton::after { content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg,transparent,rgba(255,255,255,0.35),transparent); animation:shimmer 1.4s infinite; }
    .dark .skeleton::after { background:linear-gradient(90deg,transparent,rgba(255,255,255,0.18),transparent); }
    @keyframes shimmer { 100% { transform:translateX(100%); } }

    /* Responsive adjustments for mobile */
    @media (max-width: 639px) {
      :root {
        --day-min: 32px; /* smaller day columns on mobile */
        --row-h: 48px;   /* slightly smaller rows */
      }
      .card {
        padding: 0.8rem; /* smaller card padding */
      }
      .btn-primary {
        padding: .5rem .9rem;
        font-size: .75rem;
      }
      .btn-soft {
        padding: .4rem .7rem;
        font-size: .65rem;
      }
    }

    /* Enhanced animations and micro-interactions */
    .card {
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
    }
    .btn-primary, .btn-soft {
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
    }
    .btn-soft:hover {
      transform: translateY(-1px);
    }
    
    /* Improved focus states for accessibility */
    .btn-primary:focus, .btn-soft:focus, input:focus {
      outline: 2px solid #10b981;
      outline-offset: 2px;
    }
    
    /* Smooth transitions for theme switching */
    * {
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }
    
    /* Ensure modals and popups are always visible */
    .z-50 {
      z-index: 99999 !important;
    }
    
    /* Modal backdrop blur and overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(4px);
      z-index: 99998;
    }
    
    /* Popup positioning and visibility */
    .popup-container {
      position: relative;
      z-index: 99999 !important;
    }
    
    .popup-content {
      position: absolute !important;
      z-index: 100000 !important;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(16px);
    }
    
    .dark .popup-content {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    /* Prevent other elements from creating stacking contexts above popups */
    .card {
      position: relative;
      z-index: 1;
    }
    
    .card:hover {
      z-index: 2;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200 dark:from-[#0b1118] dark:via-[#0d161f] dark:to-[#101c28] text-slate-800 dark:text-slate-200 selection:bg-emerald-500/30 selection:text-emerald-100">
<div id="root"></div>
<!-- PWA Install Prompt Container -->
<div id="pwa-install-prompt" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] max-w-sm z-[100000] hidden">
  <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white/90 dark:bg-slate-800/90 backdrop-blur p-4 shadow-xl shadow-black/20 flex flex-col gap-3">
    <div class="flex items-start gap-3">
      <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-white font-bold text-sm">App</div>
      <div class="flex-1">
        <h3 class="text-sm font-semibold text-slate-800 dark:text-slate-100">Cài đặt ứng dụng</h3>
        <p class="text-xs mt-1 text-slate-600 dark:text-slate-400 leading-snug">Thêm Habit Tracker vào màn hình chính để dùng nhanh, offline và toàn màn hình.</p>
      </div>
      <button id="pwa-install-close" aria-label="Đóng" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5.22 5.22a.75.75 0 011.06 0L8 6.94l1.72-1.72a.75.75 0 111.06 1.06L9.06 8l1.72 1.72a.75.75 0 11-1.06 1.06L8 9.06l-1.72 1.72a.75.75 0 01-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 010-1.06z" clip-rule="evenodd"/></svg>
      </button>
    </div>
    <div class="flex gap-2">
      <button id="pwa-install-dismiss" class="flex-1 btn-soft !py-2 text-xs">Để sau</button>
      <button id="pwa-install-action" class="flex-1 btn-primary !py-2 text-xs">Cài đặt</button>
    </div>
    <div id="pwa-ios-hint" class="hidden text-[11px] text-slate-500 dark:text-slate-400 leading-snug pt-1">Nhấn nút Chia sẻ rồi chọn "Add to Home Screen".</div>
  </div>
</div>

<!-- Drag scroll helper -->
<script>
  (function(){
    let isDown=false,startX,scrollLeft,el;const threshold=3;let moved=false;
    function md(e){const t=e.target.closest('[data-drag-scroll]');if(!t)return;isDown=true;el=t;startX=e.pageX-t.offsetLeft;scrollLeft=t.scrollLeft;moved=false;document.body.classList.add('dragging-x');}
    function mm(e){if(!isDown||!el)return;const x=e.pageX-el.offsetLeft;const walk=(x-startX);if(Math.abs(walk)>threshold)moved=true;el.scrollLeft=scrollLeft-walk;}
    function mu(){if(isDown){isDown=false;document.body.classList.remove('dragging-x');if(moved)window.getSelection&&window.getSelection().removeAllRanges();}}
    function leave(){mu();}
    window.addEventListener('mousedown',md,{passive:true});
    window.addEventListener('mousemove',mm,{passive:true});
    window.addEventListener('mouseup',mu,{passive:true});
    window.addEventListener('mouseleave',leave,{passive:true});
    // horizontal with wheel (shift not required)
    window.addEventListener('wheel',function(e){const t=e.target.closest('[data-drag-scroll]');if(!t||Math.abs(e.deltaX)>Math.abs(e.deltaY))return; if(e.deltaY!==0){t.scrollLeft+=e.deltaY; e.preventDefault();}}, {passive:false});
  })();
</script>

<!-- Enable ES module imports inside Babel-transpiled code by adding data-type="module" -->
<!-- Core utility & component scripts (no modules, global scope) -->
<script type="text/babel" data-presets="react" src="src/utils.js"></script>
<script type="text/babel" data-presets="react" src="src/components/AddHabit.js"></script>
<script type="text/babel" data-presets="react" src="src/components/HabitScheduleButton.js"></script>
<script type="text/babel" data-presets="react" src="src/components/MiniCalendar.js"></script>
<script type="text/babel" data-presets="react" src="src/components/MonthYearPicker.js"></script>
<script type="text/babel" data-presets="react" src="src/components/ContributionCalendar.js"></script>
<script type="text/babel" data-presets="react" src="src/App.js"></script>
</body>
<script>
  // Service worker registration with auto-refresh on new version
  (function(){
    if(!('serviceWorker' in navigator)) return;
    const REG_PATH = '/service-worker.js';
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if(refreshing) return; refreshing = true; window.location.reload();
    });
    async function register(){
      try {
        const reg = await navigator.serviceWorker.register(REG_PATH, { updateViaCache: 'none' });
        // Listen messages from SW (activation notice)
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(e.data && e.data.type==='SW_ACTIVATED'){ /* could show toast */ }
        });
        // Check for updates periodically
        setInterval(()=>{ reg.update().catch(()=>{}); }, 5*60*1000);
        // If waiting worker exists, trigger skipWaiting to activate immediately
        if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
        reg.addEventListener('updatefound', () => {
          const nw = reg.installing; if(!nw) return;
          nw.addEventListener('statechange', () => {
            if(nw.state==='installed' && navigator.serviceWorker.controller){
              // new content ready -> activate now
              nw.postMessage({type:'SKIP_WAITING'});
            }
          });
        });
      } catch(e) { console.warn('SW reg failed', e); }
    }
    window.addEventListener('load', register);
  })();
  </script>
  <script>
    // PWA Install Prompt (mobile A2HS)
    (function(){
      const promptEl = document.getElementById('pwa-install-prompt');
      const actionBtn = document.getElementById('pwa-install-action');
      const dismissBtn = document.getElementById('pwa-install-dismiss');
      const closeBtn = document.getElementById('pwa-install-close');
      const iosHint = document.getElementById('pwa-ios-hint');
      let deferredEvt = null;
      const LS_KEY = 'ht_pwa_prompt_v1';
      const MIN_DAYS = 2; // only show if user used app after some time (can extend with usage metrics)

      function isStandalone(){
        return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      }
      function isMobile(){
        return /android|iphone|ipad|ipod/i.test(navigator.userAgent);
      }
      function shouldShow(){
        if(!isMobile() || isStandalone()) return false;
        try{
          const raw = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
          if(raw.dismissed) return false;
          if(raw.firstSeen){
            const days = (Date.now() - raw.firstSeen) / 86400000;
            if(days < MIN_DAYS) return false;
          } else {
            raw.firstSeen = Date.now();
            localStorage.setItem(LS_KEY, JSON.stringify(raw));
            return false; // set baseline first visit
          }
          return true;
        }catch(e){ return true; }
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredEvt = e;
        if(shouldShow()) showPrompt();
      });

      function showPrompt(){
        if(!promptEl) return;
        // Detect iOS (no beforeinstallprompt support)
        const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent) && !window.MSStream;
        if(isIOS){
          iosHint.classList.remove('hidden');
          actionBtn.classList.add('hidden');
        }
        promptEl.classList.remove('hidden');
        promptEl.animate([{ transform:'translate(-50%, 30px)', opacity:0 }, { transform:'translate(-50%,0)', opacity:1 }], { duration:260, easing:'ease-out' });
      }

      actionBtn?.addEventListener('click', async () => {
        if(!deferredEvt) return;
        deferredEvt.prompt();
        const choice = await deferredEvt.userChoice.catch(()=>({ outcome:'dismissed'}));
        if(choice.outcome === 'accepted') markDone();
        hidePrompt();
      });
      dismissBtn?.addEventListener('click', () => { markDismissed(); hidePrompt(); });
      closeBtn?.addEventListener('click', () => { markDismissed(); hidePrompt(); });

      function hidePrompt(){
        promptEl.animate([{ opacity:1, transform:'translate(-50%,0)'},{ opacity:0, transform:'translate(-50%,10px)'}], { duration:180, easing:'ease-in' }).onfinish = ()=>{
          promptEl.classList.add('hidden');
        };
      }
      function markDismissed(){ try { localStorage.setItem(LS_KEY, JSON.stringify({ dismissed:true })); } catch(e){} }
      function markDone(){ try { localStorage.setItem(LS_KEY, JSON.stringify({ installed:true })); } catch(e){} }

      // Fallback for iOS (no event) after delay
      setTimeout(()=>{
        if(!deferredEvt && shouldShow()) showPrompt();
      }, 4000);
    })();
  </script>
</html>